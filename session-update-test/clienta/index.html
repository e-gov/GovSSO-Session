<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <title>clienta.localhost</title>
    <script type="application/javascript">
        function performFetch(resource, method, mode) {
            (async () => {
                await fetch(resource, {
                    method: method,
                    credentials: 'include',
                    mode: mode
                }).then(function (response) {
                    console.log('fetch response.ok=' + response.ok + ', response.status=' + response.status);
                    if (response.ok) {
                        return response.json().then((data) => console.log(data));
                    }
                }).catch((error) => {
                    console.error('fetch error:', error);
                });
            })();
        }
        function performXMLHttpRequest(resource, method) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, resource, true);
            xhr.withCredentials = true;
            xhr.send();
        }
    </script>
    <script type="application/javascript">
        function receiveMessage(event) {
            console.log("Received event", event);
            for (let iframe of document.getElementsByTagName("iframe")) {
                console.log("Deleting iframe " + iframe.src);
                iframe.remove();
            }
        }
        window.addEventListener("message", receiveMessage, true);
    </script>
    <script type="application/javascript">
        function createIframe(src) {
            const iframe = document.createElement("iframe");
            iframe.setAttribute("src", src);
            //iframe.style.display = "none";
            iframe.style.width = "640px";
            iframe.style.height = "480px";
            document.body.append(iframe);
        }

        function iframeGatewayPostMessage() {
            createIframe("https://gateway.localhost:52443/post-message.html");
        }
        function iframeClientGatewayPostMessage() {
            createIframe("https://clienta.localhost:51443/redirect-gateway-post-message");
        }
        function iframeGatewayClientPostMessage() {
            createIframe("https://gateway.localhost:52443/redirect-client-post-message");
        }
        function iframeClientGatewayClientPostMessage() {
            createIframe("https://clienta.localhost:51443/redirect-client-post-message");
        }
        function iframeStorageAccessGatewayPostMessage() {
            const next = "https://gateway.localhost:52443/post-message.html";
            alert("Press \"trigger\" in the iframe below");
            createIframe("https://gateway.localhost:52443/storage-access.html?next=" + encodeURIComponent(next));
        }
        function iframeStorageAccessGatewayClientPostMessage() {
            const next = "https://gateway.localhost:52443/redirect-client-post-message";
            alert("Press \"trigger\" in the iframe below");
            createIframe("https://gateway.localhost:52443/storage-access.html?next=" + encodeURIComponent(next));
        }
    </script>
</head>
<body>
    <h1>clienta.localhost</h1>
    <p>
        <button onclick="requestAccess()">Request access (Storage access API)</button><br/>
        Storage access API status: <div id="status">Unset</div><br/>
        <button onclick="window.location.href = 'https://clienta.localhost:51443/setcookies';">set cookies on clienta</button><br/>
        <button onclick="window.location.href = 'https://gateway.localhost:52443/setcookies';">set cookies on gateway</button><br/>
    </p>
    <h2>Background request to same domain, which redirects to different domain and back</h2>
    <p>
        <button onclick="performFetch('https://clienta.localhost:51443/redirect', 'GET', 'cors');">Fetch (GET, cors)</button><br/>
        <button onclick="performFetch('https://clienta.localhost:51443/redirect', 'GET', 'no-cors');">Fetch (GET, no-cors)</button><br/>
        <button onclick="performXMLHttpRequest('https://clienta.localhost:51443/redirect', 'GET');">XMLHttpRequest (GET)</button><br/>
        <button onclick="performFetch('https://clienta.localhost:51443/redirect', 'POST', 'cors');">Fetch (POST, cors)</button><br/>
        <button onclick="performFetch('https://clienta.localhost:51443/redirect', 'POST', 'no-cors');">Fetch (POST, no-cors)</button><br/>
        <button onclick="performXMLHttpRequest('https://clienta.localhost:51443/redirect', 'POST');">XMLHttpRequest (POST)</button><br/>
    </p>
    <ul>
        <li><strong>1st request to same domain</strong><br/>
            Cookie: __Host-SessionSameSiteStrict=a<br/>
            Cookie: __Host-SessionSameSiteLax=a<br/>
            Cookie: __Host-SessionSameSiteNone=a<br/>
            Cookie: __Host-SessionSameSiteMissing=a<br/>
            Cookie: __Host-FixedSameSiteStrict=a<br/>
            Cookie: __Host-FixedSameSiteLax=a<br/>
            Cookie: __Host-FixedSameSiteNone=a<br/>
            Cookie: __Host-FixedSameSiteMissing=a<br/>
            Sec-Fetch-Dest: empty<br/>
            Sec-Fetch-Mode: cors<br/>
            Sec-Fetch-Site: same-origin</li>
        <li><strong>2nd request redirected to different domain</strong><br/>
            Cookie: __Host-SessionSameSiteNone=b - Firefox release version doesn't include (Firefox nightly includes with GOVSSO-Client, but not here?), Chrome incognito doesn't include<br/>
            Cookie: __Host-FixedSameSiteNone=b - Firefox release version doesn't include (Firefox nightly includes with GOVSSO-Client, but not here?), Chrome incognito doesn't include<br/>
            Origin: https://clienta.localhost:51443 - not included on no-cors<br/>
            Sec-Fetch-Dest: empty<br/>
            Sec-Fetch-Mode: cors<br/>
            Sec-Fetch-Site: cross-site</li>
        <li><strong>3rd request redirected back to same domain</strong><br/>
            Cookie: __Host-SessionSameSiteStrict=a - Firefox doesn't include<br/>
            Cookie: __Host-SessionSameSiteLax=a - Firefox doesn't include<br/>
            Cookie: __Host-SessionSameSiteNone=a<br/>
            Cookie: __Host-SessionSameSiteMissing=a<br/>
            Cookie: __Host-FixedSameSiteStrict=a - Firefox doesn't include<br/>
            Cookie: __Host-FixedSameSiteLax=a - Firefox doesn't include<br/>
            Cookie: __Host-FixedSameSiteNone=a<br/>
            Cookie: __Host-FixedSameSiteMissing=a<br/>
            Origin: null - not included on no-cors<br/>
            Sec-Fetch-Dest: empty<br/>
            Sec-Fetch-Mode: cors<br/>
            Sec-Fetch-Site: cross-site</li>
    </ul>
    <h2>Background request to different domain which redirects back</h2>
    <p>
        <button onclick="performFetch('https://gateway.localhost:52443/redirect', 'GET', 'cors');">Fetch (GET, cors)</button><br/>
        <button onclick="performFetch('https://gateway.localhost:52443/redirect', 'GET', 'no-cors');">Fetch (GET, no-cors)</button><br/>
        <button onclick="performXMLHttpRequest('https://gateway.localhost:52443/redirect', 'GET');">XMLHttpRequest (GET)</button><br/>
        <button onclick="performFetch('https://gateway.localhost:52443/redirect', 'POST', 'cors');">Fetch (POST, cors)</button><br/>
        <button onclick="performFetch('https://gateway.localhost:52443/redirect', 'POST', 'no-cors');">Fetch (POST, no-cors)</button><br/>
        <button onclick="performXMLHttpRequest('https://gateway.localhost:52443/redirect', 'POST');">XMLHttpRequest (POST)</button><br/>
    </p>
    <ul>
        <li><strong>1st request to different domain</strong><br/>
            Cookie: __Host-SessionSameSiteNone=b - Firefox doesn't include, Chrome incognito doesn't include<br/>
            Cookie: __Host-FixedSameSiteNone=b - Firefox doesn't include, Chrome incognito doesn't include<br/>
            Origin: https://clienta.localhost:51443 - not included on no-cors<br/>
            Sec-Fetch-Dest: empty<br/>
            Sec-Fetch-Mode: cors<br/>
            Sec-Fetch-Site: cross-site</li>
        <li><strong>2nd request redirected back to same domain</strong><br/>
            Cookie: __Host-SessionSameSiteStrict=a - Firefox doesn't include<br/>
            Cookie: __Host-SessionSameSiteLax=a - Firefox doesn't include<br/>
            Cookie: __Host-SessionSameSiteNone=a<br/>
            Cookie: __Host-SessionSameSiteMissing=a<br/>
            Cookie: __Host-FixedSameSiteStrict=a - Firefox doesn't include<br/>
            Cookie: __Host-FixedSameSiteLax=a - Firefox doesn't include<br/>
            Cookie: __Host-FixedSameSiteNone=a<br/>
            Cookie: __Host-FixedSameSiteMissing=a<br/>
            Origin: null - not included on no-cors<br/>
            Sec-Fetch-Dest: empty<br/>
            Sec-Fetch-Mode: cors<br/>
            Sec-Fetch-Site: cross-site</li>
    </ul>
    <h2>iframe: redirect to different domain</h2>
    <p>
        <button onclick="iframeGatewayPostMessage();">Gateway</button><br/>
        <button onclick="iframeClientGatewayPostMessage();">Client -> Gateway</button><br/>
        <button onclick="iframeGatewayClientPostMessage();">Gateway -> Client</button><br/>
        <button onclick="iframeClientGatewayClientPostMessage();">Client -> Gateway -> Client</button><br/>
        <button onclick="iframeStorageAccessGatewayPostMessage();">Storage access -> Gateway</button><br/>
        <button onclick="iframeStorageAccessGatewayClientPostMessage();">Sorage access -> Gateway -> Client</button><br/>
    </p>
</body>
</html>
